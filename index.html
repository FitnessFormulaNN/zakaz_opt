<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNT | Order Sheet</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        /* Фикс прыжка контента */
        html { scrollbar-gutter: stable; }

        :root {
            --primary: #000000;
            --text-main: #1a1a1a;
            --text-muted: #888888;
            --border: #eeeeee;
            --accent: #22c55e;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background-color: #ffffff;
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px 140px 20px;
            display: flex;
            justify-content: center;
        }

        .container { width: 100%; max-width: 900px; }

        /* Шапка */
        header { margin-bottom: 30px; }
        .session-info { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .session-info input { 
            width: 80px; padding: 8px; border: 1px solid var(--border); 
            border-radius: 6px; font-weight: 700; text-align: center; outline: none;
        }

        /* Поиск и кнопки */
        .controls { display: flex; gap: 15px; align-items: center; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
        #search { flex-grow: 1; padding: 15px 0; border: none; font-size: 18px; outline: none; }
        
        .filter-btn {
            background: none; border: 1px solid var(--border); padding: 8px 16px;
            border-radius: 8px; cursor: pointer; font-size: 13px; transition: 0.2s;
        }
        .filter-btn.active { background: var(--primary); color: #fff; }

        /* Таблица */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; font-size: 11px; text-transform: uppercase; color: var(--text-muted); padding: 15px 0; font-weight: 500; }
        
        /* Вертикальное выравнивание по центру */
        td { padding: 20px 0; border-bottom: 1px solid var(--border); vertical-align: middle; }

        .product-name { font-size: 15px; line-height: 1.4; padding-right: 20px; }
        .prices { white-space: nowrap; width: 130px; }
        .retail { font-size: 12px; color: var(--text-muted); text-decoration: line-through; display: block; }
        .wholesale { font-weight: 600; font-size: 15px; }

        /* Поле ввода: широкое и без стрелок */
        .qty-input {
            width: 90px; padding: 12px; border: 1px solid var(--border); border-radius: 8px;
            text-align: center; font-size: 16px; font-weight: 600; outline: none;
            -moz-appearance: textfield;
        }
        .qty-input::-webkit-outer-spin-button, 
        .qty-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .qty-input:focus { border-color: var(--primary); }

        .row-total { text-align: right; font-weight: 600; font-size: 15px; width: 120px; }

        /* Панель итогов (Компактная и широкая) */
        .footer-panel {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--primary); color: white;
            width: 95%; max-width: 600px; height: 70px;
            padding: 0 40px; border-radius: 100px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); z-index: 100; box-sizing: border-box;
        }
        .stat-group { display: flex; align-items: baseline; gap: 10px; }
        .stat-label { font-size: 10px; text-transform: uppercase; opacity: 0.6; letter-spacing: 1px; }
        .stat-value { font-size: 22px; font-weight: 700; }
        .total-highlight { color: var(--accent); }

        /* Статус синхронизации */
        #syncStatus {
            position: fixed; top: 15px; right: 15px; font-size: 11px;
            padding: 6px 12px; border-radius: 20px; display: none;
        }
        .sync-active { display: block; background: #fff8e1; color: #b78103; }
        .sync-success { display: block; background: #e8f5e9; color: #2e7d32; }

        .hidden { display: none !important; }
        tr.active-row { background-color: #fafafa; }
    </style>
</head>
<body>

<div id="syncStatus"></div>

<div class="container">
    <header>
        <div class="session-info">
            <span style="font-size: 12px;">ID ЗАКАЗА:</span>
            <input type="text" id="orderId" value="1" onchange="changeOrder(this.value)">
        </div>
        <h1>SNT Order List</h1>
    </header>

    <div class="controls">
        <input type="text" id="search" placeholder="Поиск товара..." onkeyup="runFilters()">
        <button id="filledBtn" class="filter-btn" onclick="toggleFilled()">Показать заполненные</button>
    </div>

    <table id="mainTable">
        <thead>
            <tr>
                <th>Наименование</th>
                <th>Цена (Р/О)</th>
                <th style="text-align: center;">Количество</th>
                <th style="text-align: right;">Итого</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<div class="footer-panel">
    <div class="stat-group">
        <span class="stat-label">Позиций:</span>
        <span id="totalCount" class="stat-value">0</span>
    </div>
    <div class="stat-group">
        <span class="stat-label">Сумма:</span>
        <span id="totalSum" class="stat-value total-highlight">0 ₽</span>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAMOxVBF_ZuJnxymkpmSGB_yNSEzj0VInc",
        authDomain: "zakaz-opt.firebaseapp.com",
        databaseURL: "https://zakaz-opt-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "zakaz-opt",
        storageBucket: "zakaz-opt.firebasestorage.app",
        messagingSenderId: "174792411118",
        appId: "1:174792411118:web:3a765a184bf3ecefb5f0ff"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentOrderId = "1";
    let isFilterActive = false;
    let timer;

    async function load() {
        const res = await fetch('products.json');
        const data = await res.json();
        const tbody = document.getElementById('tableBody');

        tbody.innerHTML = data.map(p => `
            <tr data-id="${p.id}" data-wholesale="${p.wholesale}">
                <td class="product-name">${p.name}</td>
                <td class="prices">
                    <span class="retail">${p.retail} ₽</span>
                    <span class="wholesale">${p.wholesale} ₽</span>
                </td>
                <td align="center">
                    <input type="number" class="qty-input" placeholder="0" oninput="handleInput(this)">
                </td>
                <td class="row-total">0 ₽</td>
            </tr>
        `).join('');

        changeOrder(document.getElementById('orderId').value);
    }

    async function changeOrder(id) {
        if(!id) return;
        currentOrderId = id;
        setStatus('sync', 'Загрузка...');
        
        const snap = await db.ref('orders/' + id + '/items').once('value');
        const items = snap.val() || {};

        document.querySelectorAll('#tableBody tr').forEach(row => {
            const input = row.querySelector('.qty-input');
            input.value = items[row.dataset.id] || "";
            updateRowUI(input);
        });
        calculate();
        setStatus('success', 'Синхронизировано');
    }

    function handleInput(input) {
        updateRowUI(input);
        calculate();
        clearTimeout(timer);
        setStatus('sync', 'Сохранение...');
        timer = setTimeout(save, 1000);
    }

    function updateRowUI(input) {
        const row = input.closest('tr');
        const qty = parseInt(input.value) || 0;
        const price = parseFloat(row.dataset.wholesale);
        row.querySelector('.row-total').innerText = (qty * price).toLocaleString() + ' ₽';
        row.classList.toggle('active-row', qty > 0);
        if (isFilterActive && qty === 0) row.classList.add('hidden');
    }

    function save() {
        const items = {};
        document.querySelectorAll('#tableBody tr').forEach(row => {
            const qty = parseInt(row.querySelector('.qty-input').value) || 0;
            if (qty > 0) items[row.dataset.id] = qty;
        });
        db.ref('orders/' + currentOrderId).set({
            items, lastUpdate: new Date().toISOString(), total: document.getElementById('totalSum').innerText
        }).then(() => setStatus('success', 'Сохранено'));
    }

    function calculate() {
        let s = 0, c = 0;
        document.querySelectorAll('#tableBody tr').forEach(row => {
            const qty = parseInt(row.querySelector('.qty-input').value) || 0;
            if (qty > 0) { s += (qty * parseFloat(row.dataset.wholesale)); c++; }
        });
        document.getElementById('totalSum').innerText = s.toLocaleString() + ' ₽';
        document.getElementById('totalCount').innerText = c;
    }

    function runFilters() {
        const q = document.getElementById('search').value.toLowerCase();
        document.querySelectorAll('#tableBody tr').forEach(row => {
            const name = row.querySelector('.product-name').innerText.toLowerCase();
            const qty = parseInt(row.querySelector('.qty-input').value) || 0;
            const match = name.includes(q) && (!isFilterActive || qty > 0);
            row.classList.toggle('hidden', !match);
        });
    }

    function toggleFilled() {
        isFilterActive = !isFilterActive;
        document.getElementById('filledBtn').classList.toggle('active');
        runFilters();
    }

    function setStatus(cl, txt) {
        const s = document.getElementById('syncStatus');
        s.className = cl === 'sync' ? 'sync-active' : 'sync-success';
        s.innerText = txt; s.style.display = 'block';
        if (cl === 'success') setTimeout(() => s.style.display = 'none', 2000);
    }

    window.onload = load;
</script>
</body>
</html>
