<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNT | Cloud Order System</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #000000;
            --text-main: #1a1a1a;
            --text-muted: #888888;
            --border: #eeeeee;
            --accent: #22c55e;
            --focus-ring: #f1f1f1;
            --bg-active: #fafafa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #ffffff;
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px 140px 20px;
            display: flex;
            justify-content: center;
        }

        .container { width: 100%; max-width: 900px; }
        
        header { margin-bottom: 30px; }
        h1 { font-size: 24px; font-weight: 600; letter-spacing: -0.5px; margin: 0; }

        .controls {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        #search { 
            flex-grow: 1; 
            padding: 18px 0; 
            border: none; 
            font-size: 18px; 
            outline: none; 
            background: transparent;
        }

        .filter-btn {
            background: none; 
            border: 1px solid var(--border);
            padding: 10px 20px; 
            border-radius: 10px; 
            cursor: pointer;
            font-size: 13px; 
            font-weight: 500; 
            transition: all 0.2s;
            white-space: nowrap;
        }

        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        table { width: 100%; border-collapse: collapse; }
        
        th { 
            text-align: left; 
            font-size: 11px; 
            text-transform: uppercase; 
            color: var(--text-muted); 
            padding: 15px 0; 
            font-weight: 600;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        td { 
            padding: 20px 0; 
            border-bottom: 1px solid var(--border); 
            vertical-align: middle; /* Идеальное выравнивание по вертикали */
        }

        .product-name { font-size: 16px; line-height: 1.4; padding-right: 30px; }
        .prices { white-space: nowrap; width: 150px; }
        .retail { font-size: 12px; color: var(--text-muted); text-decoration: line-through; display: block; }
        .wholesale { font-weight: 600; font-size: 16px; margin-top: 2px; display: block; }

        /* Поле ввода количества БЕЗ стрелок */
        .qty-input {
            width: 100px; 
            padding: 14px; 
            border: 1px solid var(--border); 
            border-radius: 10px;
            text-align: center; 
            font-size: 18px; 
            font-weight: 700; 
            outline: none;
            transition: all 0.2s;
            -moz-appearance: textfield; /* Фикс для Firefox */
        }

        /* Полное удаление стрелок для Chrome, Safari, Edge, Opera */
        .qty-input::-webkit-outer-spin-button,
        .qty-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .qty-input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--focus-ring); }
        .qty-input::placeholder { color: #e5e5e5; font-weight: 400; }
        
        .row-total { text-align: right; font-weight: 700; font-size: 16px; width: 130px; }

        /* Нижняя панель */
        .footer-panel {
            position: fixed; bottom: 35px; left: 50%; transform: translateX(-50%);
            background: var(--primary); color: white; padding: 22px 45px;
            border-radius: 100px; display: flex; align-items: center; gap: 60px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); z-index: 100;
        }

        .stat-group { display: flex; flex-direction: column; }
        .stat-label { font-size: 10px; text-transform: uppercase; opacity: 0.5; letter-spacing: 1px; margin-bottom: 4px; }
        .stat-value { font-size: 24px; font-weight: 700; }
        .total-highlight { color: var(--accent); }

        /* Индикатор синхронизации */
        #syncStatus {
            position: fixed; top: 25px; right: 25px; font-size: 12px; font-weight: 500;
            padding: 10px 20px; border-radius: 30px; display: none; z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .syncing { display: block !important; background: #fffbeb; color: #92400e; }
        .saved { display: block !important; background: #f0fdf4; color: #166534; }

        .hidden-row { display: none !important; }
        tr.active { background-color: var(--bg-active); }
    </style>
</head>
<body>

<div id="syncStatus">Инициализация...</div>

<div class="container">
    <header><h1>SNT Order List</h1></header>

    <div class="controls">
        <input type="text" id="search" placeholder="Поиск по продукции..." onkeyup="applyFilters()">
        <button id="showFilledBtn" class="filter-btn" onclick="toggleFilledFilter()">Показать заполненные</button>
    </div>

    <table id="mainTable">
        <thead>
            <tr>
                <th>Наименование</th>
                <th>Цена (Р/О)</th>
                <th style="text-align: center;">Количество</th>
                <th style="text-align: right;">Итого</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<div class="footer-panel">
    <div class="stat-group">
        <span class="stat-label">Позиций</span>
        <span id="countItems" class="stat-value">0</span>
    </div>
    <div class="stat-group">
        <span class="stat-label">Сумма заказа</span>
        <span id="grandTotal" class="stat-value total-highlight">0 ₽</span>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAMOxVBF_ZuJnxymkpmSGB_yNSEzj0VInc",
        authDomain: "zakaz-opt.firebaseapp.com",
        databaseURL: "https://zakaz-opt-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "zakaz-opt",
        storageBucket: "zakaz-opt.firebasestorage.app",
        messagingSenderId: "174792411118",
        appId: "1:174792411118:web:3a765a184bf3ecefb5f0ff"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // Привязка сессии к браузеру
    let orderId = localStorage.getItem('snt_order_session');
    if (!orderId) {
        orderId = 'order_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('snt_order_session', orderId);
    }

    let isFilledFilterActive = false;
    let saveTimeout;

    async function startApp() {
        showStatus('syncing', 'Загрузка данных...');
        try {
            const response = await fetch('products.json');
            const products = await response.json();
            const tbody = document.getElementById('tableBody');

            tbody.innerHTML = products.map(p => `
                <tr data-id="${p.id}" data-wholesale="${p.wholesale}">
                    <td class="product-name">${p.name}</td>
                    <td class="prices">
                        <span class="retail">${p.retail} ₽</span>
                        <span class="wholesale">${p.wholesale} ₽</span>
                    </td>
                    <td style="text-align: center;">
                        <input type="number" class="qty-input" placeholder="0" oninput="onInputEvent(this)">
                    </td>
                    <td class="row-total">0 ₽</td>
                </tr>
            `).join('');

            // Восстановление из Firebase
            const snapshot = await database.ref('orders/' + orderId + '/items').once('value');
            const cloudItems = snapshot.val();
            
            if (cloudItems) {
                document.querySelectorAll('#tableBody tr').forEach(row => {
                    const id = row.dataset.id;
                    if (cloudItems[id]) {
                        const input = row.querySelector('.qty-input');
                        input.value = cloudItems[id];
                        updateRowVisuals(input);
                    }
                });
                updateGrandTotal();
            }
            showStatus('saved', 'Синхронизировано');
        } catch (e) { showStatus('syncing', 'Ошибка JSON / Сервера'); }
    }

    function onInputEvent(input) {
        updateRowVisuals(input);
        updateGrandTotal();
        
        clearTimeout(saveTimeout);
        showStatus('syncing', 'Сохранение...');
        saveTimeout = setTimeout(syncToCloud, 1000);
    }

    function updateRowVisuals(input) {
        const row = input.closest('tr');
        const qty = parseInt(input.value) || 0;
        const price = parseFloat(row.dataset.wholesale);
        row.querySelector('.row-total').innerText = (qty * price).toLocaleString() + ' ₽';
        
        row.classList.toggle('active', qty > 0);
        if (isFilledFilterActive && qty === 0) row.classList.add('hidden-row');
    }

    function syncToCloud() {
        const items = {};
        document.querySelectorAll('#tableBody tr').forEach(row => {
            const qty = parseInt(row.querySelector('.qty-input').value) || 0;
            if (qty > 0) items[row.dataset.id] = qty;
        });

        database.ref('orders/' + orderId).set({
            items: items,
            updatedAt: new Date().toISOString(),
            total: document.getElementById('grandTotal').innerText
        }).then(() => showStatus('saved', 'Сохранено'));
    }

    function updateGrandTotal() {
        let sum = 0, count = 0;
        document.querySelectorAll('#tableBody tr').forEach(row => {
            const qty = parseInt(row.querySelector('.qty-input').value) || 0;
            if (qty > 0) {
                sum += (qty * parseFloat(row.dataset.wholesale));
                count++;
            }
        });
        document.getElementById('grandTotal').innerText = sum.toLocaleString() + ' ₽';
        document.getElementById('countItems').innerText = count;
    }

    function toggleFilledFilter() {
        isFilledFilterActive = !isFilledFilterActive;
        const btn = document.getElementById('showFilledBtn');
        btn.classList.toggle('active');
        btn.innerText = isFilledFilterActive ? "Показать все" : "Показать заполненные";
        applyFilters();
    }

    function applyFilters() {
        const q = document.getElementById('search').value.toLowerCase();
        document.querySelectorAll('#tableBody tr').forEach(row => {
            const name = row.querySelector('.product-name').innerText.toLowerCase();
            const qty = parseInt(row.querySelector('.qty-input').value) || 0;
            const matchesSearch = name.includes(q);
            const matchesFilled = isFilledFilterActive ? qty > 0 : true;
            row.classList.toggle('hidden-row', !(matchesSearch && matchesFilled));
        });
    }

    function showStatus(type, text) {
        const s = document.getElementById('syncStatus');
        s.className = (type === 'syncing') ? 'syncing' : 'saved';
        s.innerText = text;
        s.style.display = 'block';
        if (type === 'saved') setTimeout(() => s.style.display = 'none', 2000);
    }

    window.onload = startApp;
</script>
</body>
</html>
